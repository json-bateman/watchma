// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: game_results.sql

package sqlcgen

import (
	"context"
)

const createGameParticipant = `-- name: CreateGameParticipant :one
INSERT INTO game_participants (
    game_id,
    user_id
) VALUES (?,?)
RETURNING id, game_id, user_id, "foreign"
`

type CreateGameParticipantParams struct {
	GameID int64 `json:"game_id"`
	UserID int64 `json:"user_id"`
}

func (q *Queries) CreateGameParticipant(ctx context.Context, arg CreateGameParticipantParams) (GameParticipant, error) {
	row := q.db.QueryRowContext(ctx, createGameParticipant, arg.GameID, arg.UserID)
	var i GameParticipant
	err := row.Scan(
		&i.ID,
		&i.GameID,
		&i.UserID,
		&i.Foreign,
	)
	return i, err
}

const createGameResult = `-- name: CreateGameResult :one
INSERT INTO game_results (
    room_name,
    winning_movie_id,
    winning_movie_name,
    winning_vote_count,
    total_players
) VALUES (?,?,?,?,?)
RETURNING id, room_name, winning_movie_id, winning_movie_name, winning_vote_count, total_players, completed_at
`

type CreateGameResultParams struct {
	RoomName         string `json:"room_name"`
	WinningMovieID   string `json:"winning_movie_id"`
	WinningMovieName string `json:"winning_movie_name"`
	WinningVoteCount int64  `json:"winning_vote_count"`
	TotalPlayers     int64  `json:"total_players"`
}

func (q *Queries) CreateGameResult(ctx context.Context, arg CreateGameResultParams) (GameResult, error) {
	row := q.db.QueryRowContext(ctx, createGameResult,
		arg.RoomName,
		arg.WinningMovieID,
		arg.WinningMovieName,
		arg.WinningVoteCount,
		arg.TotalPlayers,
	)
	var i GameResult
	err := row.Scan(
		&i.ID,
		&i.RoomName,
		&i.WinningMovieID,
		&i.WinningMovieName,
		&i.WinningVoteCount,
		&i.TotalPlayers,
		&i.CompletedAt,
	)
	return i, err
}

const getGameResultsByUser = `-- name: GetGameResultsByUser :many
SELECT gr.id, gr.room_name, gr.winning_movie_id, gr.winning_movie_name, gr.winning_vote_count, gr.total_players, gr.completed_at FROM game_results gr
JOIN game_participants gp ON gr.id = gp.game_id
WHERE gp.user_id = ?
ORDER BY gr.completed_at DESC
`

func (q *Queries) GetGameResultsByUser(ctx context.Context, userID int64) ([]GameResult, error) {
	rows, err := q.db.QueryContext(ctx, getGameResultsByUser, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []GameResult{}
	for rows.Next() {
		var i GameResult
		if err := rows.Scan(
			&i.ID,
			&i.RoomName,
			&i.WinningMovieID,
			&i.WinningMovieName,
			&i.WinningVoteCount,
			&i.TotalPlayers,
			&i.CompletedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getMostPopularWinningMovies = `-- name: GetMostPopularWinningMovies :many
SELECT
    winning_movie_id,
    winning_movie_name,
    COUNT(*) as win_count,
    COALESCE(AVG(winning_vote_count), 0.0) as avg_votes
FROM game_results
GROUP BY winning_movie_id, winning_movie_name
ORDER BY win_count DESC
LIMIT ?
`

type GetMostPopularWinningMoviesRow struct {
	WinningMovieID   string      `json:"winning_movie_id"`
	WinningMovieName string      `json:"winning_movie_name"`
	WinCount         int64       `json:"win_count"`
	AvgVotes         interface{} `json:"avg_votes"`
}

func (q *Queries) GetMostPopularWinningMovies(ctx context.Context, limit int64) ([]GetMostPopularWinningMoviesRow, error) {
	rows, err := q.db.QueryContext(ctx, getMostPopularWinningMovies, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []GetMostPopularWinningMoviesRow{}
	for rows.Next() {
		var i GetMostPopularWinningMoviesRow
		if err := rows.Scan(
			&i.WinningMovieID,
			&i.WinningMovieName,
			&i.WinCount,
			&i.AvgVotes,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
